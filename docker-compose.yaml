# Docker Compose for local development / EC2 Docker deployment
# This runs the full observability stack locally without Kubernetes

version: "3.8"

services:
  # ---- Node.js Orders API ----
  orders-api:
    build: ./app
    ports:
      - "3000:3000"
    environment:
      - PORT=3000
      - OTEL_SERVICE_NAME=orders-api
      - OTEL_EXPORTER_OTLP_ENDPOINT=http://otel-collector:4318
      - NODE_OPTIONS=--require ./src/instrumentation.js
    depends_on:
      - otel-collector

  # ---- OpenTelemetry Collector (fan-out) ----
  otel-collector:
    image: otel/opentelemetry-collector-contrib:0.96.0
    volumes:
      - ./otel-collector-config.yaml:/etc/otelcol-contrib/config.yaml
    ports:
      - "4317:4317"
      - "4318:4318"
    depends_on:
      - grafana-lgtm
      - signoz-otel-collector

  # ---- Grafana LGTM (Grafana + Loki + Tempo + Prometheus) ----
  grafana-lgtm:
    image: grafana/otel-lgtm:latest
    ports:
      - "3001:3000"   # Grafana UI
      - "4320:4317"   # OTLP gRPC
      - "4321:4318"   # OTLP HTTP
      - "9090:9090"   # Prometheus
    volumes:
      - grafana-data:/data/grafana
      - loki-data:/data/loki
      - tempo-data:/data/tempo
      - prometheus-data:/data/prometheus

  # ---- SigNoz ClickHouse ----
  signoz-clickhouse:
    image: clickhouse/clickhouse-server:24.1-alpine
    ports:
      - "8123:8123"
      - "9000:9000"
    environment:
      - CLICKHOUSE_DB=signoz_traces
      - CLICKHOUSE_USER=default
      - CLICKHOUSE_PASSWORD=
    volumes:
      - clickhouse-data:/var/lib/clickhouse

  # ---- SigNoz OTel Collector ----
  signoz-otel-collector:
    image: signoz/signoz-otel-collector:0.102.12
    command: ["--config=/etc/otel/config.yaml"]
    ports:
      - "4322:4317"
      - "4323:4318"
    environment:
      - CLICKHOUSE_HOST=signoz-clickhouse
      - CLICKHOUSE_PORT=9000
      - CLICKHOUSE_USER=default
      - CLICKHOUSE_PASSWORD=
    depends_on:
      - signoz-clickhouse

  # ---- SigNoz Query Service ----
  signoz-query:
    image: signoz/query-service:0.45.1
    ports:
      - "8080:8080"
    environment:
      - ClickHouseUrl=tcp://signoz-clickhouse:9000
      - STORAGE=clickhouse
      - GODEBUG=netdns=go
    depends_on:
      - signoz-clickhouse

  # ---- SigNoz Frontend ----
  signoz-frontend:
    image: signoz/frontend:0.45.1
    ports:
      - "3301:3301"
    environment:
      - FRONTEND_API_ENDPOINT=http://signoz-query:8080

  # ---- Elasticsearch ----
  elasticsearch:
    image: docker.elastic.co/elasticsearch/elasticsearch:8.14.0
    ports:
      - "9200:9200"
    environment:
      - discovery.type=single-node
      - xpack.security.enabled=false
      - ES_JAVA_OPTS=-Xms256m -Xmx256m
    volumes:
      - es-data:/usr/share/elasticsearch/data

  # ---- Kibana ----
  kibana:
    image: docker.elastic.co/kibana/kibana:8.14.0
    ports:
      - "5601:5601"
    environment:
      - ELASTICSEARCH_HOSTS=http://elasticsearch:9200
    depends_on:
      - elasticsearch

  # ---- Elastic APM Server ----
  apm-server:
    image: docker.elastic.co/apm/apm-server:8.14.0
    ports:
      - "8200:8200"
    command: >
      apm-server -e
        -E apm-server.host=0.0.0.0:8200
        -E output.elasticsearch.hosts=["http://elasticsearch:9200"]
    depends_on:
      - elasticsearch

volumes:
  grafana-data:
  loki-data:
  tempo-data:
  prometheus-data:
  clickhouse-data:
  es-data:
